<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修改头像</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/ys.css">
</head>
<body style="background-color: #eee">
<div class="toolbar">
    <a class="back" href="./i.member.html"><div class="back-into"></div></a>
    <span>修改头像</span>
    <!--<a href="i.addaddress.html" class="addadress">新增地址</a>-->
</div>
<div class="modifyimg_1">
    <!--<div class="modifyimg_2">-->
        <!--<input type="file" class="modifyimg_3">-->
        <!--<button class="modifyimg_3">上传头像</button>-->
    <!--</div>-->


    <form class="container" enctype="multipart/form-data" method="post" id='formBox' name="form">
        <input type="file" id="chooseImage" name="file" value="">
        <button class="modifyimg_2">上传</button>
        <!-- 保存用户自定义的背景图片 -->
        <img id="cropedBigImg" value='custom' alt="" data-address='' title="自定义背景"/>
    </form>
</div>
</body>
</html>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>

<script>
    var $_331 = jQuery.noConflict();
    $_331('#chooseImage').on('change',function(){
        var filePath = $_331(this).val(),         //获取到input的value，里面是文件的路径
            fileFormat = filePath.substring(filePath.lastIndexOf(".")).toLowerCase();
        src = window.URL.createObjectURL(this.files[0]); //转成可以在本地预览的格式
        // 检查是否是图片
        if( !fileFormat.match(/.png|.jpg|.jpeg/) ) {
            error_prompt_alert('上传错误,文件格式必须为：png/jpg/jpeg');
            return;
        }
        $_331('#cropedBigImg').attr('src',filePath);
        $_331('#loding').show();
        $_331('#cropedBigImg').attr('src',src);
    });

    var mykey = "union_supermarket_2018";
    var $_331 = jQuery.noConflict(true);
    $_331(document).on('click','.modifyimg_2',function(){//上传图片
        if($_331("#chooseImage")[0].files[0]){
            var reg = /image\/*/;
            var bloe = reg.test($_331("#chooseImage")[0].files[0].type);

            if(bloe){
                var obj = {};
                obj.access_token = sessionStorage.access_token;
                obj.timestamp = parseInt(new Date().getTime()/1000);
                obj.form = "web";
                var str = srotKeyObjAndMd5(obj);
                var arr = str.split("&");
                var formData = new FormData();
                for(var i = 0;i<arr.length;i++){
                    formData.append(arr[i].split("=")[0],arr[i].split("=")[1]);
                }
                formData.append('file', $_331("#chooseImage")[0].files[0]);  /*获取上传的图片对象*/
                $_331.ajax({
                    url: 'http://140.143.25.27:8080/attachment/upload?',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success:function(data){
                        console.log(data);  /*服务器端的图片地址*/
                        console.log("ok");
                        alert("上传成功!");
                    },
                    error:function(err){
                        console.log(err);
                        console.log("err");
                    }
                });
            }else{
                alert("请选择图片");
            }
        }else{
            alert("请选择图片");
        }
    });
    function srotKeyObjAndMd5(obj){
        var arr = [];
        var newobj = {};
        for(var key in obj){
            arr.push(key);
        }
        arr.sort();
        var i=0;
        for(var key in obj){
            newobj[arr[i]] = obj[arr[i]];
            i++;
        };
        var str = '';
        for(var key in newobj){
            str += key +"="+ newobj[key] + "&";
        }
        var newstr = str.substr(0,str.length-1);

        var encodeStr = encodeURIComponent(newstr) + mykey;
        var sign = md5(encodeStr);
        newstr += "&sign=" + sign;
        return newstr;
    }

</script>
