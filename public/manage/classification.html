<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link href="myadmin/assets/css/bootstrap.css" rel="stylesheet" />
    <link href="myadmin/assets/css/font-awesome.css" rel="stylesheet" />
    <link href="myadmin/assets/js/morris/morris-0.4.3.min.css" rel="stylesheet" />
    <link href="myadmin/assets/css/custom-styles.css" rel="stylesheet" />
    <link href="myadmin/css/common.css" rel="stylesheet">
    <!-- <link href='http://fonts.useso.com/css?family=Open+Sans' rel='stylesheet' type='text/css' /> -->
    <title>Document</title>
</head>
<style>
    .data-title{
        height: 44px;
        margin-bottom: 20px;
        background: #fff;
    }
    .data-title p{
        padding:12px 0 0 12px;
    }
    .data-body{
        width: 100px;
        overflow: auto;
    }
    .body-left-ul li:hover{
        background: #575757;
        color: #F36A5A;  
    }
    .body-data-box{
        height: 120px;
        width: 100%;
        padding-right: 10px;
        background: white;
    }
    .row-box{
        padding:15px;
    }
    .body-data-num{
        padding: 0px;
    }
    .body-data-name{
        padding: 0px 0px 0px 20px;
        font-size: 16px;
        color: #AAB5BC;
        font-weight: 600;
        text-transform: uppercase;        
    }
    .body-data-num{
        padding: 30px 0px 0px 20px;
        font-size: 32px;
        font-weight: 600;
        color: #676767;
    }
    .user-manage li{
        height: 40px;
        line-height: 40px;
        padding: 5px 0px;
        margin: 20px 0px;     
    }
    .user-manage li input{
        width: 450px;
        margin-right: 20px;
        padding-left: 10px;
    }
    .add-user {
        height: 24px;
        position: relative;
        overflow: hidden;
        margin-top:40px;
        /* overflow:visible; */
    }
    #add-user-btn{
        display: inline-block;
        padding: 0 10px;
        width: 35px;
        height: 24px;
        margin-left: 20px;
    }
    .input-user{
        width: 450px;
        height: 30px;
        position: absolute;
        top: 30px;
    }
    .input-user input{
        width: 400px;
        height: 35px;
        padding-left: 10px;
    }
    .user-manage button{
        padding: 0px 10px;
        margin: 0px 2px;
    }
    .input-user button{
        height: 34px;
        margin: 0 2px;
        padding: 0 5px;
    }
</style>
<body>
    <div class="admin-container">
        <div class="admin-nav">
            <div class="admin-nav-left">联家管理系统</div>
            <div class="admin-nav-right">
            <div class="back-login"><a href="#">退出登录</a></div>
            </div>
        </div>
        <div class="body">
            <div class="body-left">
                <ul class="body-left-ul">
                    <li><a href="./index.html">首页</a></li>
                    <li><a href="./control.html">控制面板</a></li>
                    <li><a href="./store.html">店铺管理</a></li>
                    <li><a href="./commodity.html">商品管理</a></li>
                    <li><a href="./order.html">订单详情</a></li>
                    <li><a href="./user.html">用户管理</a></li>
                    <li><a href="./address.html">地址管理</a></li>
                    <li><a href="./advertising.html">广告公告</a></li>
                    <li class="active"><a href="./classification.html">商品分类</a></li>
                    <li><a href="./store_manage.html">店长管理</a></li>
                    <li><a href="./courier.html">店员管理</a></li>
                    <li><a href="./integral.html">积分管理</a></li>
                    <li><a href="./coupon.html">优惠券管理</a></li>
                </ul>
            </div>
            <div class="body-right">
            <div class="body-right-title">商品分类</div>
            <div class="body-right-data">
                <div class="add-commodify" style="padding-bottom:30px;">
                    <button type="button" class="btn btn-primary admin-btn" data-toggle="modal" data-target="#exampleModal" data-whatever="增加类别" 
                    data-list="catName_类别名:^:|*-*|0">增加类别</button>                   
                </div>
                <ul class="user-manage">
                        <!-- <li><div><span>商品类名: &nbsp;</span><input type="text" value="张三"><button>修改</button><button>删除</button></div></li>
                        <li><div><span>商品类名: &nbsp;</span><input type="text" value="李四"><button>修改</button><button>删除</button></div></li>
                        <li><div><span>商品类名: &nbsp;</span><input type="text" value="王五"><button>修改</button><button>删除</button></div></li> -->
                </ul>
                <div class="add-user">
                    <!-- <span style="font-size: 16px;">&nbsp;商品分类修改</span>
                    <button id="add-user-btn">+</button>                   
                    <div class="input-user"><input type="text" placeholder="输入用户" /><button>修改</button></div> -->
                </div> 
            </div>
        </div>
        <div class="floor"></div>

        <!-- 模态框的弹出 -->
        <div class="modal fade mymodal" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="exampleModalLabel">消息</h4>
                </div>
                <div class="modal-body append-form">
                    <!-- <div class="form-group">
                        <label for="recipient-name" class="control-label">修改客户</label>
                        <input type="text" class="form-control" id="recipient-name">
                    </div>
    
                    <ul class="list-group">
                        <li class="list-group-item">
                            <div class="form-group">
                                <label for="index" class="control-label">姓名</label>
                                <input type="text" class="form-control" id="index">
                            </div>
                            <div class="form-group">
                                <label for="index1" class="control-label">手机号</label>
                                <input type="text" class="form-control" id="index1">
                            </div>
                        </li>
                    </ul> -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="modal-commit">提交</button>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script src="myadmin/assets/js/jquery-1.10.2.js"></script>
    <script src="myadmin/assets/js/bootstrap.min.js"></script>
    <script src="myadmin/assets/js/jquery.metisMenu.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
    <script type="text/javascript" src="myadmin/js/config.js"></script>
    <!-- <script src="../cdn/jquery3.3.1.min.js"></script>
    <script src="../cdn/md5.min.js"></script> -->
    <script>
        var $_331 = jQuery.noConflict();

        (function(){
        console.log(url);
        //动态生成page页
        $('.page ul').append("<li><</li>");
        for(var i = 0; i<5;i++){
            $('.page ul').append("<li>"+i+"</li>");
        };
        $('.page ul').append("<li>></li>");
        $("#headingOne1").on("click",function(){
            $('#collapseOne').collapse('toggle');
        });
        $('.collapse').collapse();


        //模态框的弹出
        $('#exampleModal').on('show.bs.modal',function(event){
            var button = $(event.relatedTarget);
            var recipient = button.data('whatever');
            var list = button.data('list');
            var a = list.split('&%_%&');
            var obj = {};
            var arr = [];
            for(var i in a){
                arr[i] = [];
                arr[i][0] = a[i].split(":^:")[0];
                arr[i][1] = a[i].split(":^:")[1].substr(0,a[i].split(":^:",2)[1].length-1) == "|*-*|" ? "" : a[i].split(":^:")[1].substr(0,a[i].split(":^:")[1].length-1);
                arr[i][2] = a[i].split(":^:")[1].substr(a[i].split(":^:",2)[1].length-1,1);
            }       
            //增加节点name_名字:0&%_%&age_年龄:1&%_%&phone_手机:2
            var appendNode = '<div class="form-group"><label for="recipient-name" class="control-label">内容'
            +'</label><input type="button" class="form-control" id="recipient-name" value="'+recipient
            +'" style="text-align:start"></div><ul class="list-group"><li class="list-group-item" id="modal-list">';
            
            for(var i = 0; i<arr.length ;i++){
                if(arr[i][2] == 9){
                    console.log("添加图片"); 
                    appendNode +='<div class="form-group"><label for="exampleInputFile">选择图片</label><input id="img-input" type="file" filetype="image/*" name="'
                    +arr[i][0].split('_')[0]
                    +'"><p class="help-block"></p><button class="btn_img btn">点击上传</button></div>';
                }else if(arr[i][2] == 8){
                    appendNode +='<div class="form-group"><label for="'
                    +a[i].split(':^:')[0].split('_')[0]
                    +'" class="control-label">'
                    +a[i].split(':^:')[0].split('_')[1]
                    +'</label><input type="text" data-enable-time=true data-time_24hr=true class="form-control flatpickr" id="index" name="'
                    +a[i].split(':^:')[0].split('_')[0]+'" value="'
                    +a[i].split(':^:')[1]+'"></div>';
                }else{
                    appendNode += '<div class="form-group"><label for="'
                    +arr[i][0].split('_')[0]+'" class="control-label">'
                    +arr[i][0].split('_')[1]
                    +'</label><input type="text" class="form-control" id="index" name="'
                    +arr[i][0].split('_')[0]+
                    '" value="'
                    +arr[i][1]+
                    '"></div>';
                };
            }
            appendNode += '</li></ul>';
            $(".append-form").html(appendNode);
            // document.getElementsByClassName("flatpickr").flatpickr();
            var modal = $(this);
            modal.find('.modal-title').text("管理");
            // modal.find('.modal-body input').val(recipient);
        });

        //模态框内容的提交
        $("#modal-commit").on('click',function(){//增加分类
            var data = {};
            console.log($("#modal-list input").length);
            for(var i=0; i<$("#modal-list .form-group").length;i++){
                if($("#modal-list .form-group").eq(i).find("input").attr("type")=="file"){
                }else{
                    data[$("#modal-list .form-group").eq(i).find("input").attr("name")]= $("#modal-list input").eq(i).val();
                }           
            };

            // alert($(".form-group input[name='catName']").val());
            if (/^[\u4E00-\u9FA5]{1,5}$/.test($(".form-group input[name='catName']").val())){

                console.log("this is file",data);
                data.access_token = sessionStorage.access_token;
                data.timestamp=parseInt(new Date().getTime()/1000);
                data.from="web";

                var newObj = srotKeyObj(data);
                var str = objmd5(newObj);

                var newUrl = url + "category/add?" + str;
                // var newUrl = url + "category/find?" + str;
                console.log(newUrl);
                $.ajax({
                    url:newUrl,
                    type:"get",
                    dataType:"json",
                    success:function(data,status){
                        console.log(data);
                        console.log("ok");
                        alert("分类添加成功");
                        $('.modal').modal("hide");
                        findCategory();
                    },
                    error:function(err){
                        console.log(err);
                        alert("分类添加失败");
                    }
                });
                 alert("提交成功!");

            }else {
                alert("只能输入1-5中文汉字");
            }

        });

        function findCategory(){//查找分类

            // <li><div><span>商品类名: &nbsp;</span><input type="text" value="张三"><button>修改</button><button>删除</button></div></li>
            var data1 = {};
            data1.access_token = sessionStorage.access_token;
            data1.timestamp=parseInt(new Date().getTime()/1000);
            data1.from="web";

             var newObj = srotKeyObj(data1);
            var str = objmd5(newObj);

            // var newUrl = url + "category/add?" + str;
            var newUrl = url + "category/find?" + str;
            console.log(newUrl);

            $.ajax({
                url:newUrl,
                type:"get",
                dataType:"json",
                success:function(data,status){
                    console.log(data);
                    console.log("ok",data.data.length);
                    var a = '';
                    for(var i = 0;i<data.data.length;i++){
                        a += '<li><div><span>商品类名: &nbsp;</span><input type="text" value="'+data.data[i].catName+'" ><button class="categoryUpdate" data-id="'
                        +data.data[i].catId+
                        '">修改</button><button class="categoryDelete" data-id="'
                        +data.data[i].catId+
                        '">删除</button></div></li>';
                    }
                    console.log(a);
                    $(".user-manage").html(a);
                    // $(".modal").modal();
                    // findCategory();
                },
                error:function(err){
                    console.log(err);
                }
            });
        }

        findCategory();

        $(document).on("click",".categoryUpdate",function(){//更新分类
            console.log("categoryUpdate");
            // console.log($(this).data("id"));
            // alert($(this).data("id"));
            // alert($(".category_input").val());
            if (/^[\u4E00-\u9FA5]{1,5}$/.test($(this).parent().find("input").val())){
                if(confirm("商品类名修改，请再次确认是否修改？")){
                var obj = {};
                obj.access_token = sessionStorage.access_token;
                obj.catId = $(this).data("id");
                obj.catName = $(this).parent().find("input").val();
                obj.timestamp = parseInt(new Date().getTime()/1000);
                obj.from = "web";
                var newObj = srotKeyObj(obj);
                var str = objmd5(newObj);
                var newUrl = url + "category/update?" + str;
                console.log(newUrl);
                $.ajax({
                    url:newUrl,
                    type:"get",
                    dataType:"json",
                    success:function(data){
                        console.log(data);
                        console.log("request ok");
                        alert("更新成功");
                        findCategory();
                    },
                    error:function(er){
                        console.log(err);
                        console.log("请求错误");
                    }
                
                });
                 alert("修改成功!");
                }


            }else {
                alert("只能输入1-5中文汉字");
            }




            // var obj = {};
            // obj.access_token = sessionStorage.access_token;
            // obj.catId = $(this).data("id");
            // obj.catName = $(this).parent().find("input").val();
            // obj.timestamp = parseInt(new Date().getTime()/1000);
            // obj.from = "web";
            // var newObj = srotKeyObj(obj);
            // var str = objmd5(newObj);
            // var newUrl = url + "category/update?" + str;
            // console.log(newUrl);
            // $.ajax({
            //     url:newUrl,
            //     type:"get",
            //     dataType:"json",
            //     success:function(data){
            //         console.log(data);
            //         console.log("request ok");
            //         findCategory();
            //     },
            //     error:function(er){
            //         console.log(err);
            //         console.log("请求错误");
            //     }
            //
            // });
            //


        });

        $(document).on("click",".categoryDelete",function(){//删除分类
            console.log("categoryUpdate");
            if(confirm("商品类名删除，请再次确认是否删除？")) {
                var obj = {};
                obj.access_token = sessionStorage.access_token;
                obj.catId = $(this).data("id");
                obj.timestamp = parseInt(new Date().getTime() / 1000);
                obj.from = "web";

                var newObj = srotKeyObj(obj);
                var str = objmd5(newObj);
                var newUrl = url + "category/delete?" + str;

                $.ajax({
                    url: newUrl,
                    type: "get",
                    dataType: "json",
                    success: function (data) {
                        console.log(data);
                        console.log("request ok");
                    },
                    error: function (er) {
                        console.log(err);
                        console.log("请求错误");
                    }

                });
            }
            console.log(newUrl);


        });




        /*
		 *对象key值排序
		 *@paremet 对象
		 */
		function srotKeyObj(obj){
            var arr = [];
            var newobj = {};
            for(var key in obj){
                arr.push(key);
            }
            arr.sort();
            var i=0;
            for(var key in obj){
                newobj[arr[i]] = obj[arr[i]];
                i++;
            };
            return newobj;
        };
        /*
         *加密获取签名
         *@paramet 对象
         */
         function objmd5(obj){
            var str = '';
            for(var key in obj){
                str +=  key +"="+ obj[key] + "&";
            }
            var newstr = str.substr(0,str.length-1);
            var encodeStr = encodeURIComponent(newstr) + mykey;
            encodeStr = encodeStr.replace(/\(/g,'%28');
            encodeStr = encodeStr.replace(/\)/g,'%29');
            var sign = md5(encodeStr);
            newstr += "&sign=" + sign;
            return newstr;
        };
        })();
        $(document).on('click','.btn_img',function(){
                console.log("上传图片"); 
                var formData=new FormData();
                formData.append("access_token","3401cf0d-87ce-4806-82d4-895cb6678479");
                formData.append('timestamp',parseInt(new Date().getTime()/1000));
                formData.append('file', $("#img-input")[0].files[0]);  /*获取上传的图片对象*/
                var data = {};
                console.log(formData);
                data.access_token = "d3ba726f-3cfe-4bed-82ba-303521f67253";
                // data.file = formData;
        //         $_331.ajax({
        //               url: 'http://140.143.25.27:8080/attachment/upload/',
        //               type: 'POST',
        //               data: formData,
        //               contentType: false,
        //               processData: false,
        //               success:function(args){
        //                   console.log(args);  /*服务器端的图片地址*/
        //                   //$("#avatarPreview").attr('src','/'+args);  /*预览图片*/
        //                   //$("#avatar").val('/'+args);  /*将服务端的图片url赋值给form表单的隐藏input标签*/
        //          },
        //               error:function(err){
        //                   console.log(err);
        //               }
        //       });
        });
    </script>
</body>
</html>